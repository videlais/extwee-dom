!function(t){var e={};function r(n){if(e[n])return e[n].exports;var a=e[n]={i:n,l:!1,exports:{}};return t[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(n,a,function(e){return t[e]}.bind(null,a));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}r.r(e);var a=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;n(this,t),this.name=e,this.tags=r,this.metadata=a,this.text=s,this.pid=o};function s(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var o=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.name="Unknown",this.metadata={ifid:"",format:"",formatVersion:"",zoom:"",start:""},this.passages=[],this.creator="extwee-dom",this.creatorVersion="1.0.2"}var e,r,n;return e=t,(r=[{key:"getStylePassages",value:function(){var t=[];return this.passages.length>0&&(t=this.passages.filter((function(t){return t.tags.filter((function(t){return"stylesheet"===t})).length>0}))),t}},{key:"getScriptPassages",value:function(){var t=[];return this.passages.length>0&&(t=this.passages.filter((function(t){return t.tags.filter((function(t){return"script"===t})).length>0}))),t}},{key:"deleteAllByTag",value:function(t){this.passages.length>0&&(this.passages=this.passages.filter((function(e){return!e.tags.includes(t)})))}},{key:"getStartingPassage",value:function(){var t=null,e=null;if(Object.prototype.hasOwnProperty.call(this.metadata,"start")&&""!==this.metadata.start&&(e=this.metadata.start),this.passages.length>0)for(var r in this.passages){if(this.passages[r].name===e){t=this.passages[r].pid;break}"Start"===this.passages[r].name&&(t=this.passages[r].pid)}if(null===t)throw new Error("Starting passage not found!");return t}}])&&s(e.prototype,r),n&&s(e,n),t}();function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var u=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";i(this,t),this.story=new o,this._passageMetadataError=!1,this._storydataError=!1,this.parse(e)}var e,r,n;return e=t,(r=[{key:"parse",value:function(t){var e=this;if(0===t.length)throw new Error("No file contents!");var r=[],n=(":"!==t[0]&&":"!==t[1]?t.slice(t.indexOf("::"),t.length):t).split("\n::");n[0]=n[0].slice(2,n[0].length);var s=0;n.forEach((function(t){var n,o="",i="",l="",u=t.slice(0,t.indexOf("\n"));n=t.substring(u.length+1,t.length).trim();var f=u.lastIndexOf("{"),c=u.lastIndexOf("}");if(-1!==f&&-1!==c&&(i=u.slice(f,c+1),u=u.substring(0,f)+u.substring(c+1)),i.length>0)try{i=JSON.parse(i)}catch(t){e._passageMetadataError=!0}var h=u.lastIndexOf("["),p=u.lastIndexOf("]");if(-1!==h&&-1!==p&&(o=u.slice(h,p+1),u=u.substring(0,h)+u.substring(p+1)),o.length>0){var y=[];if(""!==(o=o.substring(1,o.length-1))&&(y=o.split(" ")),y.length>1){var g=[];y.forEach((function(t){g.push(t.trim())})),o=g}else if(1===y.length){var d=o;(o=[]).push(d)}else o=[]}else o=[];if(o=o.filter((function(t){return""!==t})),!((u=u.trim()).length>0))throw new Error("Malformed passage header!");l=u,e._passageMetadataError&&console.warn('Error parsing metadata for "'+l+'". It was ignored.'),r.push(new a(l,o,i,n,s)),s++}));var o=r.find((function(t){return"StoryTitle"===t.name}));if(void 0!==o?(this.story.name=o.text,r=r.filter((function(t){return"StoryTitle"!==t.name}))):this.story.name="Unknown",void 0!==(o=r.find((function(t){return"StoryData"===t.name})))){try{this.story.metadata=JSON.parse(o.text)}catch(t){this._storydataError=!0}r=r.filter((function(t){return"StoryData"!==t.name}))}this._storydataError&&console.warn("Error with processing StoryData JSON data. It was ignored."),this.story.passages=r}}])&&l(e.prototype,r),n&&l(e,n),t}();function f(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var c=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.story=null,this.parse(e)}var e,r,n;return e=t,(r=[{key:"parse",value:function(t){var e=(new DOMParser).parseFromString(t,"text/html"),r=e.querySelector("tw-storydata");if(this.story=new o,null==r)throw new Error("Not a Twine 2-style file!");var n=r.attributes;this.story.name=n.name.nodeValue,this.story.creator=n.creator.nodeValue,this.story.creatorVersion=n["creator-version"].nodeValue,this.story.metadata={},this.story.metadata.ifid=n.ifid.nodeValue,this.story.metadata.format=n.format.nodeValue,this.story.metadata.formatVersion=n["format-version"].nodeValue,this.story.metadata.zoom=n.zoom.nodeValue,this.story.metadata.start=n.startnode.nodeValue;var s=e.querySelectorAll("tw-passagedata");this.story.passages=[];var i=1;for(var l in this.story.passages.push(new a("StoryTitle",[],{},this.story.name,i)),i++,s){var u=s[l].attributes,f=s[l].innerText;if(void 0!==u){var c=u.position.nodeValue,h=u.size.nodeValue,p=u.name.nodeValue,y="";u.tags.nodeValue.length>0&&'""'!==u.tags.nodeValue&&(y=u.tags.nodeValue),y=(y=y.split(" ")).filter((function(t){return""!==t})),this.story.passages.push(new a(p,y,{position:c,size:h},f,i)),i++}}var g=e.querySelector("#twine-user-stylesheet");null!=g&&g.innerText.length>0&&this.story.passages.push(new a("UserStylesheet",["stylesheet"],{},g.innerText));var d=e.querySelector("#twine-user-script");null!=d&&d.innerText.length>0&&this.story.passages.push(new a("UserScript",["script"],{},d.innerText)),this.story.metadata.start=this.story.getStartingPassage().toString(),this.story.passages.push(new a("StoryData",[],{},JSON.stringify(this.story.metadata,null,4)))}},{key:"_escapeMetacharacters",value:function(t){return t=(t=(t=(t=(t=t.replace(/\\/g,"\\")).replace(/\\\{/g,"\\\\{")).replace(/\\\}/g,"\\\\}")).replace(/\\\[/g,"\\\\[")).replace(/\\\]/g,"\\\\]")}}])&&f(e.prototype,r),n&&f(e,n),t}();function h(t){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var p=function t(e){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),"object"!==h(e))throw new Error("Expected JSON object!");this.name=e.name||null,this.version=e.version||null,this.description=e.description||null,this.author=e.author||null,this.image=e.image||null,this.url=e.url||null,this.license=e.license||null,this.proofing=e.proofing||null,this.source=e.source||null};function y(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var g=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.storyformat=null,this.parse(e)}var e,r,n;return e=t,(r=[{key:"parse",value:function(t){if(-1!==t.indexOf("harlowe")){var e=t.lastIndexOf(',"setup": function');t=t.slice(0,e)+"}"}var r=t.indexOf("{"),n=t.lastIndexOf("}");if(-1===r||-1===n)throw new Error("Unable to find Twine2 JSON chunk!");t=t.slice(r,n+1);var a="";try{a=JSON.parse(t)}catch(t){throw new Error("Unable to parse Twine2 JSON chunk!")}this.storyformat=new p(a)}}])&&y(e.prototype,r),n&&y(e,n),t}();window.extwee={TweeParser:u,StoryFormat:p,Passage:a,Story:o,HTMLParser:c,StoryFormatParser:g}}]);